<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is  18534-->


<title>Install and configure a social network with Diaspora - Debian, Ubuntu</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


</head>

<body>
<p>Setting up a social network with Diaspora, Ruby, Rails, Applications, MariaDB, NGINX</p>
    <h1>Install and configure a social network with Diaspora – Debian, Ubuntu</h1>
    
    <p><strong>Difficulty</strong>: <em>3</em><br />
        <strong>Time</strong>: <em>30 minutes</em></p>

    <p>Diaspora is an open-source, social network that is used in a distributed network. In this article, you will learn how to install and configure social network using Diaspora in a Debian or Ubuntu server. For security reasons, you should always use a <code>sudo</code> user login.</p>

<p>Before you start, make sure the server has at least 1 GB of RAM, and that the domain name points to the server. In addition, you will need to <a href ="17378">install an SSL certificate on your web server via SSH on Debian or Ubuntu</a> server. In case you need to create a swap file, then refer to: <a href="17330">Add Memory Swap - Debian</a> and <a href="17326">Add Memory Swap – Ubuntu</a></p>
<p>To install Ruby using RVM, see the articles <a href="17538">Install Ruby on Rails using RVM – Debian</a> or <a href="17534">Install Ruby on Rails using RVM – Ubuntu</a>.</p>


<h2>Install dependencies</h2>
<ul>
	<li>Install the required dependencies and update them.
	<div class="hacker">sudo apt-get update</div>
	<div class="hacker">sudo apt-get install build-essential git curl imagemagick libmagickwand-dev nodejs redis-server libcurl4-openssl-dev libxml2-dev libxslt-dev libpq-dev</div>
	<div class="hacker">rvm reinstall ruby <em><u>latest_ruby_version</u></em></div>
	<p class="note">Here, we used Ruby version 2.2.3 </p>
	<div class="hacker">rvm use <em><u>latest_ruby_version</u></em>  --default</div>

	</li>
</ul>



<h2>Install database</h2>
<p>In this  article, you will be using PostgreSQL as the database server. If you don’t have a PostgreSQL installed, then follow the steps below.</p>
<ol> 
<li>Create a file named as <code>pgdg.list</code> in <code>sources.list.d</code> directory.
   <div class="hacker">sudo touch /etc/apt/sources.list.d/pgdg.list</div>
  </li>
   <li>Open <code>/etc/apt/sources.list.d/pgdg.list</code> file.
   <div class="hacker">sudo vim /etc/apt/sources.list.d/pgdg.list</div></li>
  <li>Add the following lines:
   <div class="hacker">deb http://apt.postgresql.org/pub/repos/apt/ wheezy-pgdg main</div>
   </li>
   <li>Save and exit the file by pressing the <strong>Esc</strong> key, typing <code>:wq</code>, and then pressing the <strong>Enter</strong> key.
   </li>
   <li>Run the following command to add the key:
   <div class="hacker">wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add –</div>
    <div class="hacker">sudo apt-get update</div>
   </li>
   <li>Install PostgreSQL. After installation an account named <code>postgres</code> will be created by default
   <div class="hacker">sudo apt-get install postgresql</div>
   </li>
   </ol>
   <h2>Create Postgres user</h2>
   <ol>
   <li>To use PostgreSQL, switch to the default role <code>postgres</code>. When creating a database user, we suggest that you keep the production username the same as your application name, so it will be easier to use and remember.
   <div class="hacker">sudo -i -u postgres</div>
   <div class="hacker">createuser -s <em><u>database_user</u></em></div>
   </li>
   <li>Type the following command to access PostgreSQL prompt.
   <div class="hacker">psql</div>
   </li>

   <li>Type the following command in the PostgreSQL prompt:
   <div class="hacker">\password <em><u>database_user</u></em></div>
   </li>
   <li>When prompted for the password, enter a desired password. Re-enter the password and exit.:
   <div class="hacker">\q</div>
   </li> 
    <li>To return to your own account, type:
   <div class="hacker">exit</div>
   </li> 
</ol>
     
  
  <h2>Get the source</h2>
<ol> 
<li>Download Diaspora.
   <div class="hacker">git clone -b master git://github.com/diaspora/diaspora.git</div>
   <div class="hacker">cd diaspora</div>
   You may get the following output:
<div class="hacker">
<pre>
ruby-<em><u>some_version</u></em> is not installed.
To install do: 'rvm install ruby-<em><u>some_version</u></em>'
</pre></div>
	You can ignore the above output as the most recent version of ruby is already installed.
</li>
   <li>Generate the certificate authorities. Keep on pressing the Enter key when asked for Country Name, State or Province Name, Locality name, Organization name, and so on.
     <div class="hacker">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ssl.key -out ssl.crt</div>
     <div class="hacker">openssl dhparam 2048 > dhparam.pem</div>
	 
     You might get error saying <code>unable to write 'random state'</code>. You can ignore this. After you have generated the certificate, check its location using:
	 <div class="hacker">pwd</div>
	 Keep a note of this certificate location <code>/home/Logged_in_user/diaspora</code>.
	 </li>
	 
</ol>
   
   <h2>Configure Diaspora Database.yml</h2>
   <ol>
   <li>Copy the configuration file.
   <div class="hacker">cp config/database.yml.example config/database.yml</div>
     </li>
   <li>Edit <code>database.yml</code> file by typing:
   <div class="hacker">vim config/database.yml</div>
    </li>
	<li>Set the username and password in the <code>postgres: &postgres </code> section in the configuration file. Enter the username and password that was set earlier for posrgres user.
<div class="hacker"><pre>
  postgres: &postgres
  adapter: postgresql
  host: localhost
  port: 5432
  username: <u><em>postgres database_user</em></u>
  password: <em><u>password</u></em>
  encoding: unicode
  </pre></div>
  </li>
 <li> In the same file, comment the the mysql line and uncomment the postgres line in the <code>common: &common </code> section: 
 
<div class="hacker"><pre>
common: &common 
# Choose one of the following 
#<<: *mysql 
<<: *postgres 
</pre></div>
</li>
<li>Save and close the file by pressing the <strong>Esc</strong> key, typing <code>:wq</code>, and then pressing the <strong>Enter</strong> key.
   </li>
</ol>

  <h2>Configure Diaspora.yml</h2>
    <ol>
<li>Copy the configuration file.
<div class="hacker">cp config/diaspora.yml.example config/diaspora.yml</div></li>
<li>Open <code> config/diaspora.yml</code> file.
<div class="hacker">vim config/diaspora.yml</div></li>
   <li>Make following changes in the <code> config/diaspora.yml</code> file:
   <ul>
   <li>Find the line that starts with 'url: "https://example.org"' and uncomment it.  Change example.org to your server IP address:
        <div class="hacker"> url: "https://<em><u>Your domain or IP</u></em>"</div></li>
   <li>Find the line that reads, "certificate_authorities: '/etc/ssl/certs/ca-certificates.crt'.  Uncomment it and replace it with the fully qualifed location of your crt file, e.g. 
       <div class="hacker"> certificate_authorities: <em><u>/home/Logged_in_user/diaspora/ssl.crt</u></em></div></li>
   <li>Uncomment line 180 and edit it:
      <div class="hacker">rails_environment: '<em><u>production</u></em>'</div>
   </li>
   </ul>
   </li>
   <li>Save and close the file by pressing the <strong>Esc</strong> key, typing <code>:wq</code>, and then pressing the <strong>Enter</strong> key.
   </li>
           </ol>
  
  <h2>Install and configure Nginx</h2>
<ol> 
<li>Install Nginx.
   <div class="hacker">sudo apt-get install nginx</div>
    <div class="hacker">sudo apt-get install libgmp-dev</div>

     <div class="hacker">sudo service nginx start</div>
  </li>
   <li>Create a new configuration file.
   <div class="hacker">sudo vim /etc/nginx/conf.d/diaspora.conf</div>
   And paste the following in the configuration file. Make sure to provide the necessary changes for the underlined text wherever required.&nbsp; It is assumed your certificates and keys are installed under the /home/logged_in_user/diaspora.&nbsp; If this is not the case, edit appropriately.
   <div class="hacker">
<pre>
   upstream diaspora_server {
    server 127.0.0.1:3000;
  }

server {
    listen 80;
    server_name <em><u>your_public_ip</u></em>;
    return 301 https://<em><u>your_public_ip</u></em>$request_uri;
  }



   server {
    listen 443; # Same rules as for listen [::]:80 apply.
    server_name <em><u>your_public_ip</u></em>;
    root <em><u>/home/Logged_in_user/diaspora/public</u></em>;
    client_max_body_size 5M;
    client_body_buffer_size 256K;
    ssl on;
    ssl_certificate <em><u>/home/Logged_in_user/diaspora/ssl.crt</u></em>;
    ssl_certificate_key <em><u>/home/Logged_in_user/diaspora/ssl.key</u></em>;
    ssl_dhparam <em><u>/home/Logged_in_user/diaspora/dhparam.pem</u></em>;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:AES256:AES:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK';
    ssl_session_timeout 5m;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    try_files $uri @diaspora;


location /assets/ {
      expires max;
      add_header Cache-Control public;
    }
    location @diaspora {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://diaspora_server;
    }



  }
</pre>
   </div>
   </li>
   <li>Restart the Nginx service.
   <div class="hacker">sudo service nginx restart</div>
   </li>
</ol>
  
  
  
  <h2>Configure the bundler</h2>
<ul> 
<li>Type the following command to install the bundler. Bundler is the most common package manager used for Ruby gems.
   <div class="hacker">gem install bundler</div>
   <div class="hacker">RAILS_ENV=production DB=postgres  bin/bundle install --without test development</div>
  </li>
</ul>
   
<h2>Set up the  environment and start Diaspora</h2>
<ol>   
   <li>Initialize the database.
   <div class="hacker">RAILS_ENV=production DB=postgres  bin/rake db:create db:schema:load</div>
     <div class="hacker">RAILS_ENV=production DB=postgres bin/rake assets:precompile</div>
   </li>
    
	<li>Open <code>/etc/nginx/nginx.conf</code> file.
	<div class="hacker">sudo vim  /etc/nginx/nginx.conf</div>
	</li>
	<li>Change the <code>www-data</code> to <em><u>Logged_in_user</u></em> next to the <code>user</code> at the top of the file.</li>
<li>Restart the Nginx service.
   <div class="hacker">sudo service nginx restart</div>
   </li>
   <li>To run diaspora in the browser, type the following in the command prompt:
   <div class="hacker">DB=postgres ./script/server</div>
    
   </li>

</ol>
 <p>This completes the installation of Diaspora, and now you will be able to view the Diaspora page in a browser using <strong>https://your_public_ip</strong>.</p>
  
    <h2>Conclusion</h2>
    <p>In this article, you learned to install and configure Diaspora on your Debian or Unbuntu server. </p>
   
</body>
</html>